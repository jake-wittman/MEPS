---
title: "Trends in Preventive Care Practices among US Adults with Diabetes, 2008-2020 "
format: docx
editor: visual
bibliography: references.bib
csl: ama.csl
---

```{r}
library(gtsummary)
library(tidyverse)
library(patchwork)
library(targets)
library(gt)

`%!in%` <- Negate(`%in%`)
sigfig <- function(number, digits) {

   formatC(signif(number, digits = digits), digits = digits, format = "fg", flag = "#")
  
}

```

**Trends in Preventive Care Practices among US Adults with Diabetes, 2008-2020**

Jacob T. Wittman, PhD Kai M. Bullard Stephen R. Benoit

CDC Affiliation

\pagebreak

# Abstract

\pagebreak

# Introduction

-   Diabetes affects a lot of people
    -   Kills people, makes them sick, reduces quality of life
    -   Cost of management is high and increasing
-   Advances in diabetes management
    -   Patients with diabetes must actually receive this care
-   Present trends in self-reported receipt of preventive care practices according to MEPS from 2008 - 2020.

Diabetes is a chronic disease that affects XX people in the USA.

# Methods

## Data Source

We used data from the Medical Expenditure Panel Survey (MEPS) from years 2008 - 2020. Participants in this survey are a subsample of households that participate in the National Health Interview Survey (NHIS). The MEP survey targets the civilian noninstitutionalized population in the US and provides national and regional estimates of health care use, expenditures, sources of payment and health insurance coverage. This survey also contains information on patient demographics, socioeconomics, and, via the Diabetes Care Survey (DCS), information on diabetes preventive care practices. The DCS is a self-administered paper-and-pencil questionnaire that is provided to MEPS respondents who indicate that they have been told by a doctor or health professional that they have diabetes.

The data we used comes from the full-year consolidated file from MEPS for the 12 year time span of our report. We used a weighted population of XXX in this analysis. Our analysis is adjusted for the complex survey design, including clustering and stratification. Reported values for the proportions of different groups receiving recommended preventive care practices are age-adjusted.

# Results

# Discussion

# References

::: {#refs}
:::

# Tables

```{r}
# tar_load(age_adjusted_stats)
# age_adjusted_stats %>% 
#   #filter(stratifier != 'age') %>% 
#   mutate(age_adjusted_prop = age_adjusted_prop * 100) %>% 
#   pivot_wider(
#     id_cols = c(stratifier, variable, var_label, strata),
#     names_from = year,
#     values_from = age_adjusted_prop
#   ) %>% 
#   group_by(stratifier, strata) %>%
#   select(stratifier, var_label, `2008`:`2020`) %>%
#   gt() %>% 
#   fmt_number(columns = `2008`:`2020`, decimals = 1) %>% 
#   gtsave('table_one.docx')
```

```{r}
tar_load(age_adjusted_preventive)
preventive_practice_table <- age_adjusted_preventive %>% 
  filter(label == 'At least three preventive practices followed') %>% 
  mutate(age_adjusted_prop = age_adjusted_prop * 100) %>% 
  pivot_wider(
    id_cols = c(stratifier, variable, label, strata),
    names_from = year,
    values_from = age_adjusted_prop
  ) %>% 
  filter(strata %!in% c('Not available', 'Other Race/Not Hispanic')) %>% 
  mutate(stratifier = factor(stratifier,
                             c('overall', 'age', 'sex', 'race', 'edu', 'insurance', 'poverty')),
         strata = case_when(strata == 'stat_0' ~ '-', 
                            strata == 'Greater than HS' ~ 'Greater than high school',
                            TRUE ~ strata)) %>% 
  mutate(strata = as.factor(strata)) %>% 
  mutate(stratifier = recode_factor(
    stratifier,
    overall = 'Overall',
    age = 'Age',
    sex = 'Sex',
    race = 'Race/Ethnicity',
    edu = 'Highest degree earned',
    insurance = 'Insurance coverage',
    poverty = 'Poverty level'
  )) %>% 
  group_by(stratifier) %>%
  select(stratifier, strata, `2008`:`2020`) %>%
  gt() %>% 
  fmt_number(columns = `2008`:`2020`, decimals = 1)
preventive_practice_table$`_data` <- preventive_practice_table$`_data`[c(1:18, 20, 19, 21), ]
preventive_practice_table %>% 
  gtsave('preventive_practices.docx')
```

```{r}
# Clean up the AAPC table and get it into format for printing to table
cleaned_jp_aapc <- jp_prevention_aapc %>% 
  select(-aapc_index) %>% 
  mutate(across(starts_with('aapc'),
                ~sigfig(.x, digits = 2)),
         across(starts_with('aapc'),
                ~case_when(.x == ' NA' ~ NA_character_,
                           TRUE ~ .x)), 
         AAPC = case_when(!is.na(aapc) ~ glue::glue('{aapc} ({aapc_c_i_low}, {aapc_c_i_high})'),
                          TRUE ~ NA_character_)) %>%
  select(stratifier, strata, AAPC)

# Format APC table for future joining
cleaned_jp_apc <- jp_prevention_apc %>% 
  # No model has more than a single joinpoint, so make wider and then
  # remove the excess columns to determine if there's no join point (segmend_end = 2020)
  # or a joinpoint (segment_end != 2020)
  pivot_wider(id_cols = c(stratifier, strata, model),
              names_from = segment,
              values_from = c(segment_start, segment_end, apc, p_value, apc_significant,
                              apc_95_lcl, apc_95_ucl)
  ) %>% 
  select(-segment_start_0, -segment_start_1, -segment_end_1) %>% 
  # Make segment empty if no joinpoint
  mutate(segment = case_when(segment_end_0 == 2020 ~ NA_integer_,
                             TRUE ~ segment_end_0)) %>% 
  # MAke apc empty if not significant
  mutate(across(c(apc_0, apc_95_lcl_0, apc_95_ucl_0),
                ~ case_when(p_value_0 > 0.05 & p_value_1 > 0.05 ~ NA_real_,
                            TRUE ~ .x)), 
         across(c(apc_1, apc_95_lcl_1, apc_95_ucl_1),
                ~ case_when(p_value_0 > 0.05 & p_value_1 > 0.05 ~ NA_real_,
                            TRUE ~ .x)),
         across(starts_with('apc') | starts_with('p_'),
                ~sigfig(.x, digits = 2)),
         across(starts_with('apc') | starts_with('p_'),
                ~case_when(.x == ' NA' ~ NA_character_,
                           TRUE ~ .x))) %>% 
  # Concatenate apc column with CI columns
  mutate(`APC Period 1` = case_when(
       !is.na(apc_0) ~ glue::glue('{apc_0} ({apc_95_lcl_0}, {apc_95_ucl_0})'),
       TRUE ~ NA_character_
                                    ),
    `APC Period 2` = case_when(
       !is.na(apc_1) ~ glue::glue('{apc_1} ({apc_95_lcl_1}, {apc_95_ucl_1})'),
       TRUE ~ NA_character_
    )
  ) %>%
  select(stratifier, strata, segment, starts_with('APC '))

# Clean up the age adjusted preventive practices and then join with the aapc table
clean_age_adjusted <- age_adjusted_preventive %>% 
  # Filter to just the >=3 practices
  filter(label == 'At least three preventive practices followed') %>% 
  # Filter down to every other year
  filter(year %in% seq(2000, 2020, by = 2)) %>% 
  mutate(age_adjusted_prop = age_adjusted_prop * 100,
         chr_age_adj_prop = sigfig(age_adjusted_prop, digits = 4),
         age_adjusted_se_perc = sigfig(age_adjusted_se_perc, digits = 2),
         percentage = glue::glue('{chr_age_adj_prop} ({age_adjusted_se_perc})')) %>% 
  pivot_wider(
    id_cols = c(stratifier, variable, label, strata),
    names_from = year,
    values_from = c(age_adjusted_prop, percentage),
  ) %>% 
  # Remove excess strata
  filter(strata %!in% c('Not available', 'Other Race/Not Hispanic')) %>% 
  # Relevel stratifier factor, clean up stratifier and strata names
  mutate(stratifier = factor(stratifier,
                             c('overall', 'age', 'sex', 'race', 'edu', 'insurance', 'poverty')),
         strata = case_when(strata == 'stat_0' ~ '-', 
                            strata == 'Greater than HS' ~ 'Greater than high school',
                            TRUE ~ strata),
         `Percent Change` = sigfig(((age_adjusted_prop_2020 - age_adjusted_prop_2008) / age_adjusted_prop_2008) * 100, digits = 4)) %>% 
  select(-starts_with('age_adjusted_prop')) %>% 
  setNames(., str_replace(names(.), 'percentage_', "")) %>% 
  mutate(strata = as.factor(strata)) %>% 
  mutate(stratifier = recode_factor(
    stratifier,
    overall = 'Overall',
    age = 'Age',
    sex = 'Sex',
    race = 'Race/Ethnicity',
    edu = 'Highest degree earned',
    insurance = 'Insurance coverage',
    poverty = 'Poverty level'
  )) %>% 
  # Join with AAPC table
  left_join(cleaned_jp_aapc, by = c('stratifier', 'strata'))



cleaned_preventive_df <- left_join(clean_age_adjusted, cleaned_jp_apc, by = c('stratifier', 'strata')) %>% 
  mutate(AAPC = case_when(is.na(AAPC) & is.na(`APC Period 2`) ~ `APC Period 1`,
                          TRUE ~ AAPC),
         `APC Period 1` = case_when(is.na(`APC Period 1`) & is.na(`APC Period 2`) ~ AAPC,
                                    TRUE ~ `APC Period 1`)) %>%
  # Rename poverty levels
  mutate(strata = case_when(as.character(strata) == 'Poor/Negative' ~ '< 100%',
                            as.character(strata) == 'Low income' ~ '100% - 199%',
                            as.character(strata) == 'Middle income' ~ '200% - 399%',
                            as.character(strata) == 'High income' ~ '> 400%',
                            TRUE ~ as.character(strata))) 


preventive_practice_table <- cleaned_preventive_df %>% 
  group_by(stratifier) %>%
  select(stratifier, strata, `2008`:`2020`, `Percent Change`, `Joinpoint Year` = segment,
         `APC Period 1`, `APC Period 2`, `AAPC`) %>%
  mutate(stratifier = case_when(as.character(stratifier) == 'Poverty level' ~ 'Income as % of poverty line',
                                TRUE ~ as.character(stratifier))) %>% 
  gt() %>% 
  sub_missing(missing_text = ' ')
preventive_practice_table$`_data` <- preventive_practice_table$`_data`[c(1:18, 20, 19, 21), ]
preventive_practice_table %>% 
  gtsave('preventive_practices.docx')
```

# Figures

```{r}
tar_load(age_adjusted_stats)
tar_load(jp_proportion_plot_data)

stats_table_plot_dat <- jp_proportion_plot_data %>% 
  filter(strata != 'Total') %>%
  filter(strata != 'Not available') %>% 
  filter(strata != 'Other Race/Not Hispanic') %>% 
  mutate(variable_text = case_when(variable == 'a1c' ~ '2 or more A1C tests',
                                   variable == 'CHOL_all' ~ 'Cholesterol tested',
                                   variable == 'DENT_all' ~ '1 or more dentist visits',
                                   variable == 'eye-exam' ~ 'Eye exam with dilation',
                                   variable == 'flu' ~ 'Received flu vaccine',
                                   variable == 'foot' ~ 'Foot examination'),
         strata = case_when(strata == 'stat_0' ~ 'Overall',
                            TRUE ~ strata)) %>% 
  mutate(strata = as.factor(strata)) %>% 
  split(., f = .$stratifier)

stats_table_plot_dat <- map(stats_table_plot_dat, function(.x) {
  .x %>% 
    mutate(strata = fct_drop(strata))
})


overall_data <- stats_table_plot_dat$overall
# Remove the overall data from the list
stats_table_plot_dat <- stats_table_plot_dat[-4]
# Relevel the poverty factors
stats_table_plot_dat$poverty$strata <-
  factor(
    stats_table_plot_dat$poverty$strata,
    levels = c('High income', 'Middle income', 'Low income', 'Poor/Negative'),
    labels = c(
      '> 400% ',
      '200% - 399%',
      '100% - 199%',
      '< 100%'
      
    )
  )
test_plots <- stats_table_plot_dat %>% 
   map(
    ~ ggplot(filter(.x, variable %in% c('a1c', 'CHOL_all', 'flu')),
             aes(
      x = year,
      y = age_adjusted_prop * 100,
      group = strata,
      color = strata
    )) +
      #geom_point() +
      geom_line(aes(x = year, y = model * 100, group = strata, color = strata)) +
      geom_line(data = filter(overall_data, variable %in% c('a1c', 'CHOL_all', 'flu')),
                  aes(x = year, y = model * 100),
                  color = 'black',
                  linetype = 'dashed') +
      facet_wrap( ~ variable_text, ncol = 3) +
      theme_classic() +
      scale_y_continuous(
        limits = c(00, 100),
        breaks = seq(0, 100, 25),
        labels = seq(0, 100, 25)
      ) +
      scale_x_continuous(
        limits = c(2008, 2020),
        breaks = seq(2008, 2020, 2),
        labels = seq(2008, 2020, 2)
      ) +
      scale_color_brewer(type = 'qual', palette = 'Set2') +
      theme(axis.text = element_text(color = 'black'),
            axis.text.x = element_text(angle = 45, hjust = 0.9, vjust = 0.95),
            legend.title = element_text(size = 8),
            legend.text = element_text(size = 6)) +
      labs(x = 'Year', y = 'Percentage')
  )

test_plots[[1]] <- test_plots[[1]] + labs(color = 'Age (grouped)') +
  theme(axis.title.x = element_blank())
test_plots[[2]] <-
  test_plots[[2]] + labs(color = 'Highest degree \nobtained') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank()
  )
test_plots[[3]] <-
  test_plots[[3]] + labs(color = "Insurance") + theme(
    strip.background =  element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank()
  )
test_plots[[4]] <-
  test_plots[[4]] + labs(color = 'Income as % of \npoverty line') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank()
  )
test_plots[[5]] <-
  test_plots[[5]] + labs(color = 'Race/Ethnicity') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank()
  )
test_plots[[6]] <-
  test_plots[[6]] + labs(color = 'Sex') + theme(strip.background =  element_blank(),
                                                strip.text = element_blank(),
    axis.title.x = element_blank())
test_plots <- list(
  test_plots[[1]],
  test_plots[[6]],
  test_plots[[5]],
  test_plots[[2]],
  test_plots[[3]],
  test_plots[[4]]
)

exam_plots <- stats_table_plot_dat %>% 
   map(
    ~ ggplot(filter(.x, variable %!in% c('a1c', 'CHOL_all', 'flu')),
             aes(
      x = year,
      y = age_adjusted_prop * 100,
      group = strata,
      color = strata
    )) +
      #geom_point() +
      geom_line(aes(x = year, y = model * 100, group = strata, color = strata)) +
      geom_line(data = filter(overall_data, variable %!in% c('a1c', 'CHOL_all', 'flu')),
                  aes(x = year, y = model * 100),
                  color = 'black',
                  linetype = 'dashed') +
      facet_wrap( ~ variable_text, ncol = 3) +
      theme_classic() +
      scale_y_continuous(
        limits = c(  0, 100),
        breaks = seq(0, 100, 25),
        labels = seq(0, 100, 25)
      ) +
      scale_x_continuous(
        limits = c(2008, 2020),
        breaks = seq(2008, 2020, 2),
        labels = seq(2008, 2020, 2)
      ) +
      scale_color_brewer(type = 'qual', palette = 'Set2') +
      theme(axis.text = element_text(color = 'black'),
            axis.text.x = element_text(angle = 45, hjust = 0.9, vjust = 0.95),
            legend.title = element_text(size = 8),
            legend.text = element_text(size = 6)) +
      labs(x = 'Year', y = 'Percentage')
  )

exam_plots[[1]] <- exam_plots[[1]] + labs(color = 'Age (grouped)') +
  theme(axis.title.x = element_blank())
exam_plots[[2]] <-
  exam_plots[[2]] + labs(color = 'Highest degree \nobtained') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank()
  )
exam_plots[[3]] <-
  exam_plots[[3]] + labs(color = "Insurance") + theme(
    strip.background =  element_blank(),
    strip.text = element_blank(),
    axis.title.x = element_blank()
  )
exam_plots[[4]] <-
  exam_plots[[4]] + labs(color = 'Income as % of \npoverty line') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank()
  )
exam_plots[[5]] <-
  exam_plots[[5]] + labs(color = 'Race/Ethnicity') + theme(
    strip.background =  element_blank(),
    strip.text = element_blank()
  )
exam_plots[[6]] <-
  exam_plots[[6]] + labs(color = 'Sex') + theme(strip.background =  element_blank(),
                                                strip.text = element_blank(),
    axis.title.x = element_blank())
exam_plots <- list(
  exam_plots[[1]],
  exam_plots[[6]],
  exam_plots[[5]],
  exam_plots[[2]],
  exam_plots[[3]],
  exam_plots[[4]]
)
(all_exam_plots <- exam_plots %>% 
  wrap_plots(nrow = 6) &
  theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, 'pt')))
(all_test_plots <- test_plots %>% 
  wrap_plots(nrow = 6) &
  theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, 'pt')))
ggsave(plot = all_exam_plots,
       filename = 'figures/all_exam_plots.tiff',
       dpi = 200,
       width = 10,
       height = 7)
ggsave(plot = all_test_plots,
       filename = 'figures/all_test_plots.tiff',
       dpi = 200,
       width = 10,
       height = 7)
ggsave(plot = all_exam_plots,
       filename = 'figures/all_exam_plots.svg',
       dpi = 200,
       width = 10,
       height = 7)
ggsave(plot = all_test_plots,
       filename = 'figures/all_test_plots.svg',
       dpi = 200,
       width = 10,
       height = 7)
```
