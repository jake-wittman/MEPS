---
title: "MEPS"
format: html
editor: visual
execute:
  echo: false
  include: false
---

Notes: - Only have US Born data from 2002 - 2003, then 2007 - 2013

```{r}
# Libraries
library(tidyverse)
library(haven)
library(targets)

tar_load(dat_list)


```

# To do for 11/4 or 11/7: Figure out how to actually recode DSEYE53.

```{r}
tar_load(cleaned_dat)
```

Clean data. Here's some relevant coding information: DSEYE53: 1 - 4 can be considered yes for eye exam, 5 is never. -1 Inapplicable, -8 DK (?), -9 Not ascertained (2001 only) DSEY0353: Eye exam in 2003: 1 YES, 2 NO DSEY0253: Eye exam in 2002: 1 YES, 2 NO DSEY0153: Eye exam in 2001: 1 YES, 2 NO DSEY0453: Eye exam in 2004: 1 YES, 2 NO DSEY0553: Eye exam in 2005: 1 YES, 2 NO DSEY0654: Eye exam in 2006: 1 YES, 2 NO DSEY0754: Eye exam in 2007: 1 YES, 2 NO DSEB0153: Eye exam before 2001: 1 YES, 2 NO DSEB0253: Eye exam before 2002: 1 YES, 2 NO DSEB0353: Eye exam before 2003: 1 YES, 2 NO DSEB0453: Eye exam before 2004, 1 YES, 2 NO DSEB0553: Eye exam before 2005, 1 YES, 2 NO DSEYNV53: Never had eye exam: 1 YES, 2 NO DSEYPR53: Has diabetes caused eye problems: 1 YES, 2 NO RACEX: Race: 1 White (no other reported), 2 Black (nor), 3 Amer Indian (nor), 4 Asian (nor), 5 Native hawaiian (nor), 6 Multiple races reported RACETHNX: Race/Ethnicity: 1 - Hispanic, 2 - Black/No other race/not hispanic, 3 - Asian/No other race/not hispanic, 4 - Other race/not hispanic HIDEGYR/HIDEG: Highest degree when first entered MIPS: 1 - No Degree, 2 - GED, 3 - High School Diploma, 4 - Bacehlor's Degree, 5 - MS, 6 - Doctorate, 7 - Other, 8 - Under 16, inapplicable CHOLCK53: How long since last cholesterol check? (only available 2000 - 2016).

```{r}
tar_load(diab_dat)


ggplot(dplyr::filter(sex_indicator, variable == 'eye-exam', value %in% c(
    'Within last year',
    '2 or more A1C tests in a year',
    '1 or more foot examinations in a year',
    'Once a year',
    #Dental checkups
    'YES'  ))) + geom_line(aes(x = year, y = proportion, group = SEX))


```

```{r}
library(survey)
library(sitrep)
library(gtsummary)
library(srvyr)

diab_list <- group_split(diab_dat, year)
diab_all_svy <- diab_dat %>% 
  as_survey_design(ids = VARPSU_all, weights = DIABW, strata = VARSTR_all, nest = TRUE)
diab_svy <- diab_list[[17]] %>%
  as_survey_design(ids = VARPSU_all, weights = DIABW, strata = VARSTR_all, nest = TRUE)
diab_only <- subset(diab_svy, DIABW != 0)
#svytable(~SEX, design = diab_only)
#test <-svytable(~CHOLCK53 + USBORN_all, design = diab_only, Ntotal = 100)

tbl_svysummary(
  diab_all_srvy,
  by = year,
  include = c(#CHOL_all,
              # FLU_all,
              # DENT_all,
              DSA1C53
              # DSEY_all,
              # FEET_all
              ),
  statistic = list(all_categorical() ~ "{n}")
)
tbl_svysummary(diab_svy)

test <- diab_svy %>%
  tab_survey(
    #CHOL_all,
    #FLU_all,
    #DENT_all,
    #DSA1C53,
    DSEY_all,
    #FEET_all,
    pretty = FALSE,
    strata = 'AGE_all',
    wide = FALSE,
    statistic = list(DSEY_all ~ "{n}"),
    method = 'mean',
    #drop = c('Not ascertained', 'DK', 'Refused', 'Inapplicable'),
    keep = c(
      'Within last year',
      '2 or more A1C tests in a year',
      '1 or more foot examinations in a year',
      'Once a year',
      #Dental checkups
      'YES' # eye exam
    )
  )
```

```{r}
diab_list <- group_split(diab_dat, year)
diab_svy <- diab_list[[8]] %>% 
  as_survey_design(ids = VARPSU_all, weights = DIABW, strata = VARSTR_all, nest = TRUE)
diab_only <- subset(diab_svy, DIABDX_all == 1)
calcProp <- function(data, year, variable) {
  if (is.character(variable)) {
    vari <- enquo(variable)
    diab_svy <- data %>%
    as_survey_design(
      ids = VARPSU_all,
      weights = DIABW,
      strata = VARSTR_all,
      nest = TRUE
    )
  diab_svy %>%
    tab_survey(
      CHOL_all, FLU_all, DENT_all, DSA1C53, DSEY_all, FEET_all, #CHECK53 - not in all years
      pretty = FALSE,
      strata = !!vari,
      wide = FALSE,
      method = 'mean'
      #drop = c('Not ascertained', 'DK', 'Refused', 'Inapplicable'),
      # keep = c(
      #   'Within last year',
      #   '2 or more A1C tests in a year',
      #   '1 or more foot examinations in a year',
      #   'Once a year',
      #   #Dental checkups
      #   'YES' # eye exam
      # )
    ) %>%
    mutate(year = year)
  } else {
    vari <- variable
    diab_svy <- data %>%
    as_survey_design(
      ids = VARPSU_all,
      weights = DIABW,
      strata = VARSTR_all,
      nest = TRUE
    )
  diab_svy %>%
    tab_survey(
      CHOL_all, FLU_all, DENT_all, DSA1C53, DSEY_all, FEET_all, #CHECK53 - not in all years
      pretty = FALSE,
      strata = vari,
      wide = FALSE,
      method = 'mean'
      #drop = c('Not ascertained', 'DK', 'Refused', 'Inapplicable'),
      # keep = c(
      #   'Within last year',
      #   '2 or more A1C tests in a year',
      #   '1 or more foot examinations in a year',
      #   'Once a year',
      #   #Dental checkups
      #   'YES' # eye exam
      # )
    ) %>%
    mutate(year = year)
  }

}
safelyCalcProp <- safely(calcProp)
possiblyCalcProp <- possibly(calcProp, otherwise = NULL)
library(furrr)
future::plan(multisession, workers = 3)
overall <- future_map2(diab_list, 2001:2020, ~safelyCalcProp(.x, .y, NULL))
sex <- future_map2(diab_list, 2001:2020,  ~possiblyCalcProp(.x, .y, 'SEX'))
race <- future_map2(diab_list, 2001:2020, ~possiblyCalcProp(.x, .y, 'RACE_all'))
edu <- future_map2(diab_list, 2001:2020,  ~possiblyCalcProp(.x, .y, 'HIDEG_all'))
age <- future_map2(diab_list, 2001:2020,  ~safelyCalcProp(.x, .y, 'AGE_all'))
future::plan(sequential)


```

```{r}
race_df <- compact(race) %>% 
  bind_rows(.)
sex_df <- compact(sex) %>% 
  bind_rows(.)
edu_df <- compact(edu) %>% 
  bind_rows(.)
overall_df <- compact(overall) %>% 
  bind_rows(.)

ggplot(race_df, aes(x = year, y = proportion, group = RACE_all, colour = RACE_all)) +
  geom_line() +
  facet_wrap(~variable)

ggplot(sex_df, aes(x = year, y = proportion, group = SEX, colour = SEX)) +
  geom_line() +
  facet_wrap(~variable)

ggplot(edu_df, aes(x = year, y = proportion, group = HIDEG_all, colour = HIDEG_all)) +
  geom_line() +
  facet_wrap(~variable)

ggplot(overall_df, aes(x = year, y = proportion)) +
  geom_line() +
  facet_wrap(~variable)

```

# Get the dashboard medians

```{r}
dash_files <- list.files(here::here('data', 'dashboard'), full.names = TRUE)
dash_file_names <- str_extract(list.files(here::here('data', 'dashboard')), '^([^.])+')
dash_list <-
  map(dash_files,
      ~ read_csv(
        .x,
        skip = 2,
        col_names = TRUE,
        n_max = 21,
        col_types = c('dcddd'),
        na = c('Suppressed', 'No Data')
      ))
names(dash_list) <- dash_file_names
dash_dat <- bind_rows(dash_list, .id = 'file_name')%>% 
  separate(file_name, into = c('indicator', 'stratifier', 'strata'), sep = "_") %>% 
  janitor::clean_names() %>% 
  mutate(across(percentage:upper_limit, ~.x/100))

overall_indicator <- overall_df %>%
  mutate(
    variable = case_when(
      variable == 'FLU_all' ~ 'flu',
      variable == 'DSEY_all' ~ 'eye-exam',
      variable == 'DSA1C53' ~ 'a1c',
      variable == 'FEET_all' ~ 'foot',
      TRUE ~ variable
    )
  ) %>%
  left_join(
    .,
    filter(dash_dat, stratifier == 'total'),
    by = c('year', 'variable' = 'indicator')
  )

sex_indicator <- sex_df %>%
  mutate(
    variable = case_when(
      variable == 'FLU_all' ~ 'flu',
      variable == 'DSEY_all' ~ 'eye-exam',
      variable == 'DSA1C53' ~ 'a1c',
      variable == 'FEET_all' ~ 'foot',
      TRUE ~ variable
    ),
    SEX = case_when(SEX == 'Male' ~ 'M',
                    SEX == 'Female' ~ 'F')
  ) %>%
    left_join(
    .,
    filter(dash_dat, stratifier == 'gender'),
    by = c('year', 'variable' = 'indicator', 'SEX' = 'strata')
  )

race_indicator <- race_df %>%
  mutate(
    variable = case_when(
      variable == 'FLU_all' ~ 'flu',
      variable == 'DSEY_all' ~ 'eye-exam',
      variable == 'DSA1C53' ~ 'a1c',
      variable == 'FEET_all' ~ 'foot',
      TRUE ~ variable
    ),
    RACE_all = case_when(
      RACE_all == 'Hispanic' ~ 'hispanic',
      RACE_all == 'Black/Not Hispanic' ~ 'black',
      RACE_all == 'White/Not Hispanic' ~ 'white',
      RACE_all == 'Asian/Not Hispanic' ~ 'asian',
      TRUE ~ as.character(RACE_all)
    )
  ) %>%
    left_join(
    .,
    filter(dash_dat, stratifier == 'race'),
    by = c('year', 'variable' = 'indicator', 'RACE_all' = 'strata')
  )

edu_indicator <- edu_df %>%
  mutate(
    variable = case_when(
      variable == 'FLU_all' ~ 'flu',
      variable == 'DSEY_all' ~ 'eye-exam',
      variable == 'DSA1C53' ~ 'a1c',
      variable == 'FEET_all' ~ 'foot',
      TRUE ~ variable
    ),
    HIDEG_all = case_when(
      HIDEG_all == 'Greater than HS' ~ 'greater-than-HS',
      HIDEG_all == 'Less than high school' ~ 'less-than-HS',
      HIDEG_all == 'High school' ~ 'HS',
      TRUE ~ as.character(HIDEG_all)
    )
  ) %>%
    left_join(
    .,
    filter(dash_dat, stratifier == 'edu'),
    by = c('year', 'variable' = 'indicator', 'HIDEG_all' = 'strata')
  )

```

```{r}
overall_indicator %>%
  filter(variable %in% c('a1c', 'eye-exam', 'flu', 'foot')) %>%
  ggplot() +
  geom_line(aes(x = year, y = proportion, group = variable, linetype = 'MEPS')) +
  geom_line(aes(x = year, y = percentage, group = variable, linetype = 'Dashboard')) +
  facet_wrap( ~ variable) +
  theme_bw()


sex_indicator %>%
  filter(variable %in% c('a1c', 'eye-exam', 'flu', 'foot')) %>%
  ggplot() +
  geom_line(aes(x = year, y = proportion, group = SEX, color = SEX, linetype = 'MEPS') ) +
  geom_line(aes(x = year, y = percentage, group = SEX, color = SEX, linetype = 'Dashboard')) +
  facet_wrap( ~ variable) +
  scale_linetype_manual(labels = c('Dashboard', 'MEPS'),
                        values = c('solid', 'dashed')) +
  theme_bw()

race_indicator %>%
  filter(variable %in% c('a1c', 'eye-exam', 'flu', 'foot')) %>%
  ggplot() +
  geom_line(aes(
    x = year,
    y = proportion,
    group = RACE_all,
    color = RACE_all,
    linetype = 'MEPS'
  )) +
  geom_line(aes(
    x = year,
    y = percentage,
    group = RACE_all,
    color = RACE_all,
    linetype = 'Dashboard'
  )) +
  facet_wrap(~ variable) +
  scale_linetype_manual(labels = c('Dashboard', 'MEPS'),
                        values = c('solid', 'dashed')) +
  theme_bw()


edu_indicator %>%
  filter(variable %in% c('a1c', 'eye-exam', 'flu', 'foot')) %>%
  ggplot() +
  geom_line(aes(
    x = year,
    y = proportion,
    group = HIDEG_all,
    color = HIDEG_all,
    linetype = 'MEPS'
  )) +
  geom_line(aes(
    x = year,
    y = percentage,
    group = HIDEG_all,
    color = HIDEG_all,
    linetype = 'Dashboard'
  )) +
  facet_wrap(~ variable) +
  scale_linetype_manual(labels = c('Dashboard', 'MEPS'),
                        values = c('solid', 'dashed')) +
  theme_bw()

```


```{r}

```

